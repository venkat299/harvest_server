 {{> dependency}}
 <body>

  <div class="ui raised padded container segment">

  <input hidden="true"  class="strategy_id" value={{strategy_id}}>
  <input hidden="true"  class="temp" >
  <table class="ui striped selectable collapsing small celled  table">
    <thead>

     <tr>
            <th colspan = "6">
       <h2 class="ui header dash_header">
        <!-- <i class="settings icon "></i> -->
        <img class="mini ui image" src="/client_img/eggs.svg">
        <div class="content ">
          Watchlist : {{strategy_id}}
          <!--  <div class="sub header">_______</div> -->
        </div>
      </th>

      </th>
      <tr>

      <th colspan = "2">
        <div class="ui search small search_stock" data-action="watchlist search">
          <div class="ui icon input">
            <input class="prompt" type="text" placeholder="Search">
            <i class="search icon"></i>
          </div>
          <div class="results"></div>
        </div>
      </th>

      <th colspan="2">
       <button class="ui right floated small labeled icon button add_stock" data-action="watchlist add">
         <i class="right add icon" ></i>
         Add
       </button>
     </th>

           <th colspan="2">
       <button class="ui right floated  center small labeled icon button run_all" data-action="watchlist run_all">
         <i class="right refresh icon" ></i>
         Run All
       </button>
     </th>

   </h2>
 </tr>
 <tr>
  <th>Symbol</th>
  <th>IsActive</th>
  <th class="descending">ROR</th>
  <th class="descending">&mu;</th>
  <th class="ascending">&sigma;</th>
  <th class="time" >Updated</th>
  <!--   <th>Routine</th> -->
</tr>
</thead>
<tbody>
  {{#data}}
  <tr id="{{tradingsymbol}}" >
   <!--  <td>{{tradingsymbol}}</td> -->
   <td colspan="1">
    <button class="ui right icon small compact button run_routine"  data-strategy_id="{{strategy_id}}" data-tradingsymbol="{{tradingsymbol}}" data-action="watchlist routine">
     <i class="right repeat icon" ></i>
     {{tradingsymbol}}
   </button>
 </td>
 <td>

 <!--  <div class="ui toggle compact checkbox">
    <input type="checkbox" class="input_checkbox" name="{{tradingsymbol}}_checkbox" data-value="{{status}}">
    <label class="hide_this">{{status}}</label>
  </div> -->


  <div class="ui floating labeled compact small dropdown button" id="{{tradingsymbol}}_dropdown">
   <input type="hidden" name="status"  class="status" value="{{status}}"  autocomplete="off">
   <i class="sort icon"></i>
   <span class="text">Filter</span>
   <div class="menu">
    <div class="item green" data-value="ACTIVE">
      <a class="ui green circular label" >A</a>
    </div>
    <div class="item red" data-value="INACTIVE">
      <a class="ui red circular label" >I</a>
    </div>
  </div>
</div>
</td>
<!-- <td>{{status}}</td> -->
<td class="round_num">{{ror}}</td>
<td>{{returns_mean}}</td>
<td class="round_num">{{returns_std}}</td>
<td class="format_time" id="time_{{tradingsymbol}}">{{update_time}}</td>

</tr>
{{/data}}
</tbody>
</table>
</div>
</body>


<!-- 
    seneca.add('role:strategy,cmd:run_routine,schedule:daily', routine.daily.bind(seneca))
  seneca.add('role:watchlist,cmd:add', watchlist.add.bind(seneca))
  seneca.add('role:watchlist,cmd:retire', watchlist.retire.bind(seneca))
  seneca.add('role:watchlist,cmd:remove', watchlist.remove.bind(seneca))
    //seneca.add('role:info,req:part', aliasGet)

  -->
  <script type="text/javascript">
  var onFailure =  function(response) {
      // request failed, or valid response but response.success = false
      console.log('operation failed')
    }
    var onError =  function(errorMessage) {
      // invalid response
      console.log('request failed')
    }

    /* Define API endpoints once globally */
    $.fn.api.settings.api = {
  // 'get followers' : '/followers/{id}?results={count}',
  // 'create user'   : '/create',
  'watchlist add'      : '/watchlist/add?strategy_id={strategy_id}&tradingsymbol={tradingsymbol}',
 // 'retire stock'      : '/watchlist/retire?strategy_id={strategy_id}&tradingsymbol={tradingsymbol}',
  // 'follow user'   : '/follow/{id}',
  'watchlist routine'        : '/watchlist/routine?strategy_id={strategy_id}&tradingsymbol={tradingsymbol}',
  'watchlist search'      : '/watchlist/search?q={query}',
  'watchlist monthly_eod'      : '/watchlist/monthly_eod?', //TODO to remove from this file
  'watchlist change_status'      : '/watchlist/change_status?',
    'watchlist run_all'      : '/watchlist/run_all?'
};

$('.run_routine.button')
.api({
  onSuccess: function(response) {
      // valid response and response.success = true
      location.reload()
    },
    onFailure:onFailure ,
    onError:onError,
  }).state({
    onActivate: function() {
      $(this).state('flash text');
    }
  });

  $('.monthly_eod.button')
  .api({
    onSuccess: function(response) {
      // valid response and response.success = true
      location.reload()
    },
    onFailure:onFailure ,
    onError:onError,
  }).state({
    onActivate: function() {
      $(this).state('flash text');
    }
  });



  $('.ui.search.search_stock').search({searchFields   : [
    'title'
    ], minCharacters : 3})
  ;


  $('.add_stock.button')
  .api({
   beforeSend: function(settings) {
     var tradingsymbol = $('.ui.search.search_stock').search('get value') 
     var strategy_id = $('input.strategy_id').val()
     settings.urlData = {
      tradingsymbol:tradingsymbol,
      strategy_id:strategy_id
    };
    return settings;
  },
  onSuccess: function(response) {
      // valid response and response.success = true
      console.log('response success')
      location.reload()
    },
    onFailure:onFailure ,
    onError:onError,
  }).state({
    onActivate: function() {
      $(this).state('flash text');
    }
  });



  $('.dropdown')
  .dropdown({
    onChange: function(value, text, $selectedItem) {
     console.log(value,text,$selectedItem)
     var strategy_id = $('input.strategy_id').val();
     var status = $(this).dropdown('get value')
     var tradingsymbol= ($(this).dropdown().prop('id')).split('_')[0];
     $('.temp').api({
      action: 'watchlist change_status',
      on: 'now',
     // passed via POST
     data: {
      strategy_id: strategy_id,
      status:status,
      tradingsymbol:tradingsymbol
      //($selectedItem.before())[0].getAttribute('data-value')
    },
    onSuccess: function(response) {
      // valid response and response.success = true
      location.reload()
    },
    onFailure:onFailure ,
    onError:onError
  })
   }
 })
  ;
  $(function(){
  // convert unix date to readable date
  // $('.format_time').each(function(){
  //   $(this).text((new Date(+($(this).text()))).toString().substr(0,11))
  // });
  $('.round_num').each(function(){
    $(this).text( parseFloat(+($(this).text()),2).toFixed(2) )
  });  
    $('.format_time').each(function(){
    $(this).text(timeSince(new Date(+($(this).text()))))
  });

})
  </script>